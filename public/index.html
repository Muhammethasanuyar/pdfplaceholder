<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Placeholder Tespit & Doldur</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--b:#e5e7eb;--t:#0f172a;--m:#64748b;--p:#0e7afe}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f8fafc;color:var(--t);margin:0}
    header{padding:16px 20px;border-bottom:1px solid var(--b);background:#fff}
    h1{font-size:18px;margin:0}
    .wrap{display:grid;grid-template-columns:2fr 1fr;gap:16px;padding:16px}
    .box{background:#fff;border:1px solid var(--b);border-radius:12px;padding:12px}
    label{font-size:12px;color:var(--m)}
    input[type="file"]{display:block;margin-top:6px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select,button,input[type="text"],input[type="number"],input[type="color"],textarea{
      border:1px solid var(--b);border-radius:8px;padding:8px;background:#fff
    }
    button{background:var(--p);color:#fff;border:0;cursor:pointer}
    button.secondary{background:#475569}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--b);padding:8px;text-align:left;font-size:14px}
    th{font-weight:600;background:#f1f5f9}
    .muted{color:var(--m)}
    .pill{display:inline-block;background:#eef2ff;color:#3730a3;border-radius:999px;padding:2px 8px;font-size:12px}
    iframe{width:100%;height:80vh;border:1px solid var(--b);border-radius:12px;background:#fff;display:block}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .section-title{font-weight:700;margin:8px 0 6px}
    .hint{font-size:12px;color:#475569}
  </style>
</head>
<body>
  <header>
    <h1>Placeholder Tespit & Doldur → (İbrahim Bircan)</h1>
  </header>

  <div class="wrap">
    <!-- SOL: PDF önizleme -->
    <div class="box">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <div>
            <label>API Base URL</label>
            <input id="apiBase" type="text" value="http://localhost:8000" placeholder="http://localhost:8000" />
          </div>
          <button id="testApi" class="secondary" style="margin-top: 22px;">🔗 Test Bağlantı</button>
        </div>
        <div class="muted">OCR: <span id="ocrStatus" class="pill">—</span></div>
      </div>

      <div class="row">
        <div>
          <label>PDF Şablon</label>
          <input id="file" type="file" accept="application/pdf" />
          <div class="hint">💡 Test için placeholder'lı PDF:
            <a href="data:application/pdf;base64,JVBERi0xLjMKJeLjz9MKCjEgMCBvYmoKPDwKL1R5cGUgL0NhdGFsb2cKL09ic0lkIDIgMCBSCi9QYWdlcyAzIDAgUgo+PgplbmRvYmoKCjIgMCBvYmoKPDwKL1R5cGUgL091dGxpbmVzCi9Db3VudCAwCj4+Cj4+CjMgMCBvYmoKPDwKL1R5cGUgL1BhZ2VzCi9LaWRzIFs0IDAgUl0KL0NvdW50IDEKL01lZGlhQm94IFswIDAgNjEyIDc5Ml0KPj4KZW5kb2JqCgo0IDAgb2JqCjw8Ci9UeXBlIC9QYWdlCi9QYXJlbnQgMyAwIFIKL01lZGlhQm94IFswIDAgNjEyIDc5Ml0KL0NvbnRlbnRzIDUgMCBSCi9SZXNvdXJjZXM8PAovUHJvY1NldCBbL1BERiAvVGV4dF0KL0ZvbnQ8PAovRjEgNiAwIFIKPj4KPj4KL0Fubm90czcgMCBSCj4+Cj4+CjUgMCBvYmoKPDwKL0xlbmd0aCA0NAo+Pgplc3RyZWFtCkJUCi9GMSAxMiBUZgoxMDAgNzAwIFRkCihIZWxsbyB7e25hbWV9fSkgVGoKRVQKZW5kc3RyZWFtCmVuZG9iagoKNiAwIG9iago8PAovVHlwZSAvRm9udAovU3VidHlwZSAvVHlwZTEKL05hbWUgL0YxCi9CYXNlRm9udCAvSGVsdmV0aWNhCj4+Cj4+CjcgMCBvYmoKPDwKL1R5cGUgL0Fubm90Ci9TdWJ0eXBlIC9MaW5rCi9SZWN0IFs4MCA2ODUgMTUwIDcwNV0KL0JvcmRlciBbMCAwIDBdCi9BIDIwMCAwIFIKPj4KZW5kb2JqCgo4IDAgb2JqCjw8Ci9UeXBlIC9BY3Rpb24KL1MgL1VSSQovVVJJIChodHRwOi8vd3d3LnBkZmxpYmVyLm9yZykvCj4+Cj4+Cgp4cmVmCjAgOQowMDAwMDAwMDAwIDY1NTM1IGYNCjAwMDAwMDAwMTAgMDAwMDAgbiANCjAwMDAwMDAwNTcgMDAwMDAgbiANCjAwMDAwMDAwOTQgMDAwMDAgbiANCjAwMDAwMDAxNzQgMDAwMDAgbiANCjAwMDAwMDAzNjQgMDAwMDAgbiANCjAwMDAwMDA0MjQgMDAwMDAgbiANCjAwMDAwMDA0OTQgMDAwMDAgbiANCjAwMDAwMDA1NDQgMDAwMDAgbiANCnRyYWlsZXIKPDwKL1NpemUgOQovUm9vdCAxIDAgUgo+PgplbmRvYmoKc3RhcnR4cmVmCjU5NQolJUVPRgo=" target="_blank">Test PDF</a>
          </div>
        </div>
        <div><button id="clearFile" class="secondary" style="margin-top:22px">🗑️ Temizle</button></div>
      </div>

      <div class="row">
        <div>
          <label>AI Sağlayıcı</label>
          <select id="provider">
            <option value="auto" selected>Otomatik</option>
            <option value="local">Local (metin katmanı)</option>
            <option value="ocr">OCR (tarama PDF)</option>
          </select>
        </div>
        <div>
          <label>İşlem Modu</label>
          <select id="processMode">
            <option value="sync" selected>Eşzamanlı</option>
            <option value="async">Arka Plan (Async)</option>
          </select>
        </div>
        <div>
          <label>Silme Modu</label>
          <select id="eraseMode">
            <option value="redact" selected>redact (gerçek sil)</option>
            <option value="none">none (silme)</option>
          </select>
        </div>
        <div>
          <label>Fit Mode</label>
          <select id="fitMode">
            <option value="single" selected>single (tek satır)</option>
            <option value="multiline">multiline (kutuya sığdır)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Pad (pt)</label><br/>
          <input id="pad" type="number" step="0.5" value="0">
        </div>
        <div style="flex: 1;">
          <label>📝 Metin Rengi</label>
          <div class="row" style="gap: 6px; margin-top: 4px;">
            <input id="textHex" type="color" value="#0f172a" title="Metin rengi" style="width: 50px; height: 32px; cursor: pointer;" />
            <div class="color-presets" style="display: flex; gap: 4px; flex-wrap: wrap;">
              <div class="color-preset" data-color="#000000" style="width: 24px; height: 24px; background: #000000; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; margin-top: 4px;" title="Siyah"></div>
              <div class="color-preset" data-color="#1f2937" style="width: 24px; height: 24px; background: #1f2937; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; margin-top: 4px;" title="Koyu Gri"></div>
              <div class="color-preset" data-color="#374151" style="width: 24px; height: 24px; background: #374151; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; margin-top: 4px;" title="Gri"></div>
              <div class="color-preset" data-color="#0e7afe" style="width: 24px; height: 24px; background: #0e7afe; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; margin-top: 4px;" title="Mavi"></div>
              <div class="color-preset" data-color="#dc2626" style="width: 24px; height: 24px; background: #dc2626; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; margin-top: 4px;" title="Kırmızı"></div>
              <div class="color-preset" data-color="#059669" style="width: 24px; height: 24px; background: #059669; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; margin-top: 4px;" title="Yeşil"></div>
              <div class="color-preset" data-color="#7c3aed" style="width: 24px; height: 24px; background: #7c3aed; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; margin-top: 4px;" title="Mor"></div>
              <div class="color-preset" data-color="#ea580c" style="width: 24px; height: 24px; background: #ea580c; border-radius: 4px; cursor: pointer; border: 2px solid #ddd; margin-top: 4px;" title="Turuncu"></div>
            </div>
          </div>
        </div>
        <div>
          <label>Arka Plan</label>
          <select id="bgMode">
            <option value="none" selected>none (şeffaf)</option>
            <option value="solid">solid</option>
          </select>
        </div>
        <div>
          <label>Solid Renk</label><br>
          <input id="solidHex" type="color" value="#ffffff" title="Solid bg rengi" />
        </div>
      </div>

      <div class="row">
        <button id="detect">🔍 Placeholderları Tara</button>
        <button id="checkStatus" style="display:none;">📊 Durumu Kontrol Et</button>
      </div>

      <div style="margin-top:12px">
        <div style="position: relative; border: 2px solid #e5e7eb; border-radius: 12px; overflow: hidden; background: linear-gradient(45deg, #f8fafc 25%, transparent 25%), linear-gradient(-45deg, #f8fafc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f8fafc 75%), linear-gradient(-45deg, transparent 75%, #f8fafc 75%); background-size: 16px 16px; background-position: 0 0, 0 8px, 8px -8px, -8px 0px;">
          <iframe id="preview" title="PDF Önizleme" src="about:blank" style="width:100%; height:500px; border:none; background: rgba(255,255,255,0.95); border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <p style="text-align: center; color: #64748b; font-size: 14px; margin: 20px;">PDF önizlemesi için dosya seçin</p>
          </iframe>
          <div id="previewOverlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(248, 250, 252, 0.9); display: flex; align-items: center; justify-content: center; border-radius: 10px; pointer-events: none;">
            <div style="text-align: center; color: #64748b;">
              <div style="font-size: 48px; margin-bottom: 8px;">📄</div>
              <div style="font-size: 16px; font-weight: 500;">PDF Dosyası Seçin</div>
              <div style="font-size: 14px; margin-top: 4px;">Yukarıdan bir PDF yükleyin</div>
            </div>
          </div>
        </div>
        <div id="previewStatus" style="margin-top:8px; text-align:center; padding: 8px; background: #f1f5f9; border-radius: 6px; font-size: 14px; color: #475569;">
          <span style="display: inline-block; margin-right: 6px;">📄</span>
          PDF dosyası seçin
        </div>
      </div>
    </div>

    <!-- SAĞ: Placeholder listesi & değerler -->
    <div class="box">
      <div class="row" style="justify-content:space-between">
        <div class="muted">Durum: <span id="status" class="pill">Hazır</span></div>
        <div class="row">
          <button id="exportMap" class="secondary">Değerleri JSON indir</button>
          <button id="importMap" class="secondary">JSON içe aktar</button>
        </div>
      </div>

      <div id="summary" class="muted" style="margin-top:8px">Henüz tespit yapılmadı.</div>

      <div id="taskStatus" class="muted" style="margin-top:8px; display:none;">
        <div id="taskInfo"></div>
        <div id="taskProgress" style="margin-top:4px;">
          <div style="width:100%; height:4px; background:#e5e7eb; border-radius:2px;">
            <div id="progressBar" style="height:100%; background:#0e7afe; width:0%; transition:width 0.3s;"></div>
          </div>
        </div>
      </div>

      <div class="section-title">Yazı Ayarları (Global)</div>
      <div class="grid2" style="align-items:end">
        <div>
          <label>Font (Dosya)</label>
          <select id="fontPreset" style="width:100%">
            <option value="dejavu" selected>DejaVu Sans (fonts/DejaVuSans.ttf)</option>
            <option value="helv">Helvetica (yerleşik)</option>
            <option value="custom">Özel (aşağıya yol gir)</option>
          </select>
        </div>
        <div>
          <label>Font Dosya Yolu</label>
          <input id="fontPath" type="text" value="fonts/DejaVuSans.ttf" placeholder="ör: fonts/DejaVuSans.ttf" />
          <div class="hint">* Helvetica seçilirse boş bırakabilirsiniz.</div>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;align-items:start">
        <div>
          <label>Boyut Modu</label><br>
          <label><input type="radio" name="sizeMode" id="sizeAuto" checked> Otomatik</label><br>
          <div class="grid2" style="margin-top:6px">
            <div>
              <label>Min FS</label>
              <input id="minFs" type="number" step="0.5" value="11">
            </div>
            <div>
              <label>Maks FS</label>
              <input id="maxFs" type="number" step="0.5" value="32">
            </div>
          </div>
        </div>
        <div>
          <label>&nbsp;</label><br>
          <label><input type="radio" name="sizeMode" id="sizeFixed"> Sabit</label>
          <div style="margin-top:6px">
            <label>Sabit FS</label>
            <input id="fixedFs" type="number" step="0.5" value="14" disabled>
          </div>
        </div>
      </div>

      <div class="section-title">PDF İçindeki Gömülü Font</div>
      <div class="row">
        <select id="pdfFontSelect" style="min-width:260px">
          <option value="0" selected>PDF font seçme (AUTO)</option>
        </select>
        <span class="hint">Seçilirse doldurma bu fontu kullanmayı dener.</span>
      </div>

      <table id="keysTable" style="display:none;margin-top:14px">
        <thead>
          <tr>
            <th style="width:35%">Placeholder</th>
            <th>Değer</th>
            <th style="width:120px">Hizalama</th>
            <th style="width:15%">Pozisyon</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:12px">
        <button id="fill">PDF’yi Doldur ve İndir</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Helpers =====
    function status(txt){ document.getElementById('status').textContent = txt; }
    function pill(el, msg, type='info'){
      const colors = {info:'#6366f1', success:'#059669', warning:'#d97706', error:'#dc2626'};
      el.innerHTML = '<span class="pill" style="background:'+ (colors[type]||colors.info) +';color:#fff">'+ msg +'</span>';
    }
    function setLoading(el, on){ if(!el) return; el.disabled = !!on; el.dataset.lbl ??= el.textContent; el.textContent = on ? '⏳ ' + el.dataset.lbl.replace(/^[⏳🔍📊]/,'') : el.dataset.lbl; }
    function hexToRgb01(hex){
      let h = hex.replace('#','').trim(); if (h.length===3) h=[...h].map(c=>c+c).join('');
      return [0,2,4].map(i=> parseInt(h.slice(i,i+2),16)/255);
    }

    // ===== State =====
    let apiBase = localStorage.getItem('apiBase') || 'http://localhost:8000';
    const apiBaseEl    = document.getElementById('apiBase');
    const testApiBtn   = document.getElementById('testApi');
    const fileInput    = document.getElementById('file');
    const clearFileBtn = document.getElementById('clearFile');
    const providerEl   = document.getElementById('provider');
    const processModeEl= document.getElementById('processMode');
    const eraseModeEl  = document.getElementById('eraseMode');
    const detectBtn    = document.getElementById('detect');
    const checkStatusBtn = document.getElementById('checkStatus');
    const fillBtn      = document.getElementById('fill');
    const ocrStatusEl  = document.getElementById('ocrStatus');
    const preview      = document.getElementById('preview');
    const previewStatus= document.getElementById('previewStatus');
    const keysTable    = document.getElementById('keysTable');
    const keysTbody    = keysTable.querySelector('tbody');
    const summary      = document.getElementById('summary');
    const taskStatus   = document.getElementById('taskStatus');
    const taskInfoEl   = document.getElementById('taskInfo');
    const progressBar  = document.getElementById('progressBar');
    const exportBtn    = document.getElementById('exportMap');
    const importBtn    = document.getElementById('importMap');
    const bgModeEl     = document.getElementById('bgMode');
    const solidHexEl   = document.getElementById('solidHex');
    const textHexEl    = document.getElementById('textHex');
    const fontPresetEl = document.getElementById('fontPreset');
    const fontPathEl   = document.getElementById('fontPath');
    const sizeAutoEl   = document.getElementById('sizeAuto');
    const sizeFixedEl  = document.getElementById('sizeFixed');
    const minFsEl      = document.getElementById('minFs');
    const maxFsEl      = document.getElementById('maxFs');
    const fixedFsEl    = document.getElementById('fixedFs');
    const fitModeEl    = document.getElementById('fitMode');
    const padEl        = document.getElementById('pad');
    const fontSel      = document.getElementById('pdfFontSelect');

    let pdfFile = null;
    let detected = { pages:0, placeholders:[], unique_keys:[] };
    const keyModel = new Map(); // key -> {value, align, count}
    let currentTaskId = null;
    let statusCheckInterval = null;

    // ===== API base handling =====
    apiBaseEl.value = apiBase;
    function updateApiBase(){
      apiBase = apiBaseEl.value.trim() || 'http://localhost:8000';
      localStorage.setItem('apiBase', apiBase);
      testApiConnection();
      getOcrStatus();
    }
    apiBaseEl.addEventListener('change', updateApiBase);
    apiBaseEl.addEventListener('input', ()=>{ /* throttle not needed */ });

    // ===== OCR status =====
    async function getOcrStatus(){
      try{
        const r = await fetch(`${apiBase}/ocr_status`);
        if(!r.ok) throw new Error('HTTP '+r.status);
        const j = await r.json();
        const label = j.available ? `OK • ${j.version || 'tesseract'}` : 'YOK';
        pill(ocrStatusEl, label, j.available ? 'success' : 'warning');
        ocrStatusEl.title = (j.cmd||'') || 'PATH';
      }catch(e){
        pill(ocrStatusEl, 'erişim yok', 'warning');
      }
    }

    // ===== Test API =====
    async function testApiConnection(){
      setLoading(testApiBtn, true);
      try{
        const r = await fetch(`${apiBase}/ai_detect`, { method:'POST', body: new FormData() });
        // muhtemelen 400 döner çünkü dosya yok; önemli olan CORS/erişim
        pill(document.getElementById('status'), 'API hazır', 'success');
      }catch(e){
        pill(document.getElementById('status'), 'API erişilemiyor', 'error');
      }finally{
        setLoading(testApiBtn, false);
      }
    }

    // ===== UI toggles =====
    function updateFontPathState(){
      const v = fontPresetEl.value;
      if(v==='helv'){ fontPathEl.disabled=true; fontPathEl.value=''; }
      else if(v==='dejavu'){ fontPathEl.disabled=true; fontPathEl.value='fonts/DejaVuSans.ttf'; }
      else { fontPathEl.disabled=false; }
    }
    fontPresetEl.addEventListener('change', updateFontPathState);
    updateFontPathState();

    // ===== Color presets =====
    document.querySelectorAll('.color-preset').forEach(preset => {
      preset.addEventListener('click', () => {
        const color = preset.dataset.color;
        textHexEl.value = color;
        // Visual feedback
        document.querySelectorAll('.color-preset').forEach(p => p.style.borderColor = '#ddd');
        preset.style.borderColor = color;
        preset.style.borderWidth = '3px';
      });
    });

    function updateSizeState(){
      const fixed = sizeFixedEl.checked;
      fixedFsEl.disabled = !fixed;
      minFsEl.disabled = fixed;
      maxFsEl.disabled = fixed;
    }
    sizeAutoEl.addEventListener('change', updateSizeState);
    sizeFixedEl.addEventListener('change', updateSizeState);
    updateSizeState();

    function updateBgDisabled(){
      const redact = eraseModeEl.value === 'redact';
      bgModeEl.disabled = redact;
      solidHexEl.disabled = redact || (bgModeEl.value!=='solid');
    }
    eraseModeEl.addEventListener('change', updateBgDisabled);
    bgModeEl.addEventListener('change', updateBgDisabled);
    updateBgDisabled();

    // ===== Fonts from PDF =====
    async function loadPdfFonts(){
      if(!pdfFile) return;
      fontSel.innerHTML = '<option value="0" selected>PDF font seçme (AUTO)</option>';
      const fd = new FormData(); fd.append('template', pdfFile);
      try{
        const r = await fetch(`${apiBase}/fonts`, { method:'POST', body: fd });
        if(!r.ok) return;
        const j = await r.json();
        (j.fonts||[]).forEach(f=>{
          const label = `${f.name_stripped || f.base_stripped || f.name || f.base} (xref:${f.xref}${f.subset_like?' subset?':''}, ${f.ext||'?'}, ${f.bytes||0}B)`;
          const opt = document.createElement('option'); opt.value=String(f.xref); opt.textContent=label; fontSel.appendChild(opt);
        });
      }catch(e){ /* sessiz */ }
    }

    // ===== File handling =====
    document.addEventListener('DOMContentLoaded', ()=>{
      getOcrStatus();
      setTimeout(testApiConnection, 500);
    });

    clearFileBtn.addEventListener('click', ()=>{
      fileInput.value=''; pdfFile=null; preview.src='about:blank';
      previewStatus.innerHTML = '<span style="display: inline-block; margin-right: 6px;">📄</span>PDF dosyası seçin';
      document.getElementById('previewOverlay').style.display = 'flex';
      clearDetection();
      status('🗑️ PDF temizlendi');
    });

    function clearDetection(){
      detected = { pages:0, placeholders:[], unique_keys:[] };
      keyModel.clear(); renderTable();
      summary.textContent='Henüz tespit yapılmadı.';
      hideTaskStatus();
    }

    fileInput.addEventListener('change', ()=>{
      const f = fileInput.files?.[0];
      if(!f){ return; }
      if(f.type!=='application/pdf'){ pill(document.getElementById('status'),'PDF seçin','warning'); return; }
      if(f.size > 50*1024*1024){ pill(document.getElementById('status'),'PDF çok büyük (50MB+)','warning'); return; }
      pdfFile=f;
      const url = URL.createObjectURL(f);
      preview.src='about:blank';
      previewStatus.innerHTML = '<span style="display: inline-block; margin-right: 6px;">⏳</span>PDF yükleniyor...';
      setTimeout(()=>{ 
        preview.src=url; 
        previewStatus.innerHTML = '<span style="display: inline-block; margin-right: 6px;">✅</span>PDF yüklendi - ' + f.name;
        document.getElementById('previewOverlay').style.display = 'none';
      }, 100);
      status('✅ PDF yüklendi'); clearDetection(); loadPdfFonts();
    });

    // ===== Detect =====
    detectBtn.addEventListener('click', async ()=>{
      if(!pdfFile){ pill(document.getElementById('status'),'Önce PDF seçin','warning'); return; }
      setLoading(detectBtn, true); status('🔍 AI tespit çalışıyor...');
      const fd = new FormData(); fd.append('template', pdfFile); fd.append('provider', providerEl.value);
      try{
        const r = await fetch(`${apiBase}/ai_detect`, { method:'POST', body: fd });
        const j = await r.json();
        if(!r.ok){ throw new Error(j.error || 'AI tespit hatası'); }

        detected = j || { pages:0, placeholders:[], unique_keys:[] };

        // warning’leri göster
        if(j.warning==='tesseract_not_found_fallback_local'){
          pill(document.getElementById('status'),'Tesseract yok; Local mod kullanıldı','warning');
        }else if(j.warning==='no_text_layer_and_no_ocr'){
          pill(document.getElementById('status'),'Tarama PDF ve OCR yok; tespit yok','warning');
        }else if(j.warning==='fallback_ocr'){
          pill(document.getElementById('status'),'Metin katmanı yoktu; OCR kullanıldı','warning');
        }else{
          pill(document.getElementById('status'),'✅ Tespit tamam','success');
        }

        // tabloyu doldur - yeni pozisyon tabanlı sistem
        keyModel.clear();
        (detected.placeholders||[]).forEach(ph => { 
          const key = ph.key || ph.base_key || '';
          if (key) {
            keyModel.set(key, { 
              value: '', 
              align: 'left', 
              display_name: ph.display_name || key,
              context: ph.context || '',
              page: ph.page || 0,
              rect: ph.rect || null,
              position_index: ph.position_index || null,
              total_positions: ph.total_positions || null
            }); 
          }
        });
        renderTable();

        const uniqueCount = keyModel.size;
        const totalCount = (detected.placeholders||[]).length;
        summary.innerHTML = `📄 Sayfa: <b>${detected.pages}</b> • 🔍 Toplam Placeholder: <b>${totalCount}</b> • 🗝️ Pozisyon Bazlı: <b>${uniqueCount}</b> • ⚙️ Kullanılan: <b>${j.provider_used||'—'}</b>`;
      }catch(e){
        pill(document.getElementById('status'),'Hata: '+e.message,'error');
      }finally{
        setLoading(detectBtn, false);
      }
    });

    // ===== Table render =====
    function renderTable(){
      keysTbody.innerHTML=''; 
      const keys = Array.from(keyModel.keys());
      
      // BASE KEY GROUPING: Aynı base key'leri grupla
      const baseKeyGroups = new Map();
      keys.forEach(k => {
        const baseKey = k.split('_')[0]; // sitead_1 -> sitead
        if (!baseKeyGroups.has(baseKey)) {
          baseKeyGroups.set(baseKey, []);
        }
        baseKeyGroups.get(baseKey).push(k);
      });
      
      keysTable.style.display = baseKeyGroups.size ? 'table' : 'none';
      
      // Her base key için tek bir input göster
      baseKeyGroups.forEach((groupKeys, baseKey) => {
        const row=document.createElement('tr');
        
        // İlk key'in verilerini kullan (display için)
        const firstKey = groupKeys[0];
        const firstKeyData = keyModel.get(firstKey);

        // Placeholder ismi ve group info
        const tdKey=document.createElement('td'); 
        const keyLabel = baseKey; // Base key'i göster
        const groupInfo = groupKeys.length > 1 ? ` (${groupKeys.length} konum)` : '';
        const contextInfo = firstKeyData.context ? ` - ${firstKeyData.context.substring(0, 30)}...` : '';
        tdKey.innerHTML = `<strong>${keyLabel}</strong><span style="color:#0e7afe;">${groupInfo}</span><br><small style="color:#666">${groupKeys.join(', ')}${contextInfo}</small>`;
        
        // TEK DEĞER INPUT: Grup için tek input
        const tdVal=document.createElement('td');
        const inp=document.createElement('input'); 
        inp.type='text'; 
        inp.placeholder=`${keyLabel} değeri (tüm konumlar için)`; 
        inp.value=firstKeyData.value||'';
        
        // Input değiştiğinde TÜM group key'lere aynı değeri ata
        inp.addEventListener('input', () => {
          const newValue = inp.value;
          groupKeys.forEach(k => {
            const keyData = keyModel.get(k);
            if (keyData) keyData.value = newValue;
          });
        }); 
        tdVal.appendChild(inp);

        // Hizalama seçimi (tüm group için)
        const tdAlign=document.createElement('td');
        const sel=document.createElement('select'); 
        ['left','center','right'].forEach(a=>{
          const opt=document.createElement('option'); opt.value=a; opt.textContent=a; 
          if((firstKeyData.align||'left')===a) opt.selected=true; 
          sel.appendChild(opt);
        });
        sel.addEventListener('change', () => {
          const newAlign = sel.value;
          groupKeys.forEach(k => {
            const keyData = keyModel.get(k);
            if (keyData) keyData.align = newAlign;
          });
        }); 
        tdAlign.appendChild(sel);

        // Pozisyon bilgileri (tüm grup için)
        const tdPos=document.createElement('td'); 
        if (groupKeys.length === 1) {
          // Tek konum
          const keyData = keyModel.get(groupKeys[0]);
          const pageInfo = `Sayfa ${(keyData.page || 0) + 1}`;
          const posInfo = keyData.rect ? `(${Math.round(keyData.rect[0])}, ${Math.round(keyData.rect[1])})` : '';
          tdPos.innerHTML = `<small>${pageInfo}<br>${posInfo}</small>`;
        } else {
          // Çoklu konumlar
          const positions = groupKeys.map(k => {
            const keyData = keyModel.get(k);
            const pageInfo = `S${(keyData.page || 0) + 1}`;
            const posInfo = keyData.rect ? `(${Math.round(keyData.rect[0])},${Math.round(keyData.rect[1])})` : '';
            return `${pageInfo}:${posInfo}`;
          });
          tdPos.innerHTML = `<small>${positions.join('<br>')}</small>`;
        }
        tdPos.style.fontSize = '11px';
        tdPos.style.color = '#666';

        row.appendChild(tdKey); row.appendChild(tdVal); row.appendChild(tdAlign); row.appendChild(tdPos);
        keysTbody.appendChild(row);
      });
    }

    // ===== Export / Import =====
    exportBtn.addEventListener('click', ()=>{
      const obj={}; keyModel.forEach((v,k)=> obj[k]=v.value||'');
      const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='values.json'; a.click(); URL.revokeObjectURL(a.href);
    });
    importBtn.addEventListener('click', ()=>{
      const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.onchange=async ()=>{ const f=inp.files?.[0]; if(!f) return;
        try{ const txt=await f.text(); const obj=JSON.parse(txt);
          Object.entries(obj).forEach(([k,v])=>{ if(keyModel.has(k)){ const cur=keyModel.get(k); cur.value=String(v??''); keyModel.set(k,cur); } });
          renderTable();
        }catch(e){ alert('Geçersiz JSON: '+e.message); }
      }; inp.click();
    });

    // ===== Async task polling (only if backend async açık) =====
    function showTaskStatus(taskId){ currentTaskId=taskId; taskStatus.style.display='block'; checkStatusBtn.style.display='inline-block'; startStatusChecking(); }
    function hideTaskStatus(){ currentTaskId=null; taskStatus.style.display='none'; checkStatusBtn.style.display='none'; stopStatusChecking(); }
    function startStatusChecking(){ if(statusCheckInterval) clearInterval(statusCheckInterval); statusCheckInterval=setInterval(checkTaskStatus, 1500); }
    function stopStatusChecking(){ if(statusCheckInterval){ clearInterval(statusCheckInterval); statusCheckInterval=null; } }
    checkStatusBtn.addEventListener('click', ()=>{ if(currentTaskId) checkTaskStatus(); });

    async function checkTaskStatus(){
      if(!currentTaskId) return;
      try{
        const r=await fetch(`${apiBase}/task/${currentTaskId}`); const info=await r.json();
        if(r.ok){
          updateTaskDisplay(info);
          if(info.status==='completed'){ stopStatusChecking(); handleTaskCompleted(info); }
          else if(info.status==='failed'){ stopStatusChecking(); handleTaskFailed(info); }
        }
      }catch(e){ pill(document.getElementById('status'),'Task kontrol hatası','warning'); }
    }
    function updateTaskDisplay(info){
      const progress = info.status==='queued'?10:info.status==='processing'?50:info.status==='completed'?100:0;
      progressBar.style.width = progress+'%';
      taskInfoEl.textContent = `Durum: ${info.status} (${progress}%)` + (info.processing_time?` • Süre: ${Number(info.processing_time).toFixed(1)}s`:``);
    }
    function handleTaskCompleted(info){
      if(info.result_path){
        const a=document.createElement('a'); a.href=info.result_path; a.download='doldurulmus.pdf'; a.click();
        status('✅ PDF indirildi');
      }
    }
    function handleTaskFailed(info){ pill(document.getElementById('status'),'Görev başarısız: '+(info.error||'bilinmeyen'),'error'); }

    // ===== Fill =====
    fillBtn.addEventListener('click', async ()=>{
      if(!pdfFile){ pill(document.getElementById('status'),'Önce PDF seçin','warning'); return; }
      if(!keyModel.size){ pill(document.getElementById('status'),'Önce AI tespiti yapın','warning'); return; }

      // map & align
      const fields={}, aligns={};
      keyModel.forEach((v,k)=>{ fields[k]=v.value||''; const a=(v.align||'left').toLowerCase(); aligns[k]=a==='center'?1:a==='right'?2:0; });

      // font & size
      const fontPath = fontPathEl.value.trim();
      const sizeMode = sizeFixedEl.checked ? 'fixed' : 'auto';
      const minFs = parseFloat(minFsEl.value||'11');
      const maxFs = parseFloat(maxFsEl.value||'32');
      const fixedFs = parseFloat(fixedFsEl.value||'14');

      const fd=new FormData();
      fd.append('template', pdfFile);
      fd.append('fields_json', JSON.stringify(fields));
      fd.append('align_json', JSON.stringify(aligns));
      fd.append('provider', providerEl.value);
      fd.append('font_path', fontPath);
      fd.append('size_mode', sizeMode);
      fd.append('min_fs', String(minFs));
      fd.append('max_fs', String(maxFs));
      fd.append('fixed_fs', String(fixedFs));
      fd.append('fit_mode', fitModeEl.value);
      fd.append('pad', String(parseFloat(padEl.value||'0') || 0));
      fd.append('erase_mode', eraseModeEl.value);

      // metin rengi (0..1)
      const textRgb = hexToRgb01(textHexEl.value);
      fd.append('text_color', JSON.stringify(textRgb));

      // PDF içi font seçimi
      const xref = parseInt(fontSel?.value || '0', 10);
      if (xref > 0) fd.append('selected_font_xref', String(xref));
      fd.append('force_selected_font', '0');

      // Process mode
      const processMode = processModeEl.value; // sync | async
      fd.append('async_process', processMode==='async' ? '1' : '0');

      // (BG paramları artık sadece gösterim için; redact modunda devre dışı)
      if(bgModeEl.value==='solid' && eraseModeEl.value!=='redact'){
        const solid = hexToRgb01(solidHexEl.value);
        fd.append('bg_mode', 'solid');
        fd.append('solid_color', JSON.stringify(solid));
      }else{
        fd.append('bg_mode', 'none');
      }

      setLoading(fillBtn, true); status('🔄 PDF doldurma çalışıyor...'); hideTaskStatus();
      try{
        const r = await fetch(`${apiBase}/fill`, { method:'POST', body: fd });

        if(processMode==='async'){
          const info = await r.json();
          if(r.ok && info.task_id){ currentTaskId = info.task_id; showTaskStatus(currentTaskId); pill(document.getElementById('status'), 'Arka plan görevi başlatıldı', 'info'); }
          else { throw new Error(info.error || 'Görev başlatılamadı'); }
        }else{
          if(r.ok){
            const blob = await r.blob(); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='doldurulmus.pdf'; a.click(); URL.revokeObjectURL(a.href);
            const missing = r.headers.get('X-Missing-Keys'); if(missing){ pill(document.getElementById('status'),'Eksik alanlar: '+missing,'warning'); } else { pill(document.getElementById('status'),'✅ PDF indirildi','success'); }
          }else{
            const err = await r.json().catch(()=>({error:'Sunucu hatası'})); throw new Error(err.error || 'Sunucu hatası');
          }
        }
      }catch(e){
        pill(document.getElementById('status'),'Hata: '+e.message,'error');
      }finally{
        setLoading(fillBtn, false);
      }
    });

    // ilk açılışta OCR ve API testi
    testApiBtn.addEventListener('click', testApiConnection);
  </script>
</body>
</html>
